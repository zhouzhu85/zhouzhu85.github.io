---
layout: _post
title: RcoketMQ
date: 2023-12-15 10:28:25
tags: 
  - MQ
  - RocketMQ
category: 
  - 中间件
  - 消息队列
  - RocketMQ
---
## MQ简介
MQ，Message Queue，是一种提供消息队列服务的中间件，也称为消息中间件，是一套提供了消息生产、存储、消费全过程API的软件系统。消息即数据，一般消息的体量不会很大。

## MQ 用途
### 限流削峰
MQ可以将系统的超量请求暂存其中，以便系统后期可以慢慢进行处理，从而避免了请求的丢失或系统被压垮。
![img.png](../images/rocketmq.png)

## 异步解耦
上游系统对下游系统的调用，则会大大降低系统的吞吐量与并发度，且系统耦合度太高。而异步调用则会解决这些问题。所以两层之间若要实现由同步到异步的转化，一般做法就是，在这两层间添加一个MQ层。

## 数据收集
分布式系统会生产海量数据流，如：业务日志、监控数据、用户行为等，针对这些数据流进行实时或批量采集汇总，然后对这些数据流进行大数据分析，通过MQ完成此类数据收集是最好的选择。

## RocketMQ如何保证消息不丢失？
将消息流程分为三大部分，每一部分都有可能丢失数据
- 生产阶段：Producer通过网络将消息发送给Broker，这个发送可能会发生丢失，比如网络延迟不可用等
- 存储阶段：Broker肯定是先把消息放到内存的，然后根据刷盘策略持久化到硬盘中，如果刚收到Producer的消息，放入内存，但是异常宕机了，导致消息丢失
- 消费阶段：消费失败。比如先提交ack再消费，处理过程中出现异常，该消息就出现了丢失。

解决方案：
- 生产阶段：使用同步发送失败重试机制；异步发送重写回调方法检查发送结果；ack确认机制
- 存储阶段：同步刷盘机制；集群模式采用同步复制。
- 消费阶段：正常消费处理完成才提交ack；如果处理异常返回重试标识
 